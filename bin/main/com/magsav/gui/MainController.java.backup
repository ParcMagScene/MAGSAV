package com.magsav.gui;

import com.magsav.model.InterventionRow;
import com.magsav.model.ProductRow;
import com.magsav.repo.InterventionRepository;
import com.magsav.repo.ProductRepository;
import com.magsav.imports.CsvImporter;
import com.magsav.util.Router;
import com.magsav.util.TableFx;
import com.magsav.util.Views;

import javafx.application.Platform;
import javafx.beans.binding.Bindings;
import javafx.beans.property.ReadOnlyObjectWrapper;
import javafx.beans.property.ReadOnlyStringWrapper;
import javafx.collections.FXCollections;
import javafx.collections.transformation.FilteredList;
import javafx.collections.transformation.SortedList;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.input.Clipboard;
import javafx.scene.input.ClipboardContent;
import javafx.scene.input.MouseButton;
import javafx.scene.input.KeyCode;
import javafx.scene.input.KeyCodeCombination;
import javafx.scene.input.KeyCombination;
import javafx.stage.FileChooser;
import javafx.stage.Stage;
import javafx.event.ActionEvent;
import javafx.beans.value.ChangeListener;

import java.net.URL;
import java.util.List;

public class MainController {
  @FXML private TableView<InterventionRow> table;
  @FXML private TableColumn<InterventionRow, Long> colId;
  @FXML private TableColumn<InterventionRow, String> colStatut, colPanne, colEntree, colSortie;

  // Liste des produits à gauche
  @FXML private TableView<ProductRow> productTable;
  @FXML private TableColumn<ProductRow, String> colProdNom, colProdCode, colProdFabricant, colProdSituation;
  @FXML private TextField productSearchField;

  @FXML private Label lblProdName, lblProdCode, lblProdSN, lblProdUID, lblProdManufacturer, lblProdSituation;
  @FXML private TableView<InterventionRow> historyTable;
  @FXML private TableColumn<InterventionRow, Long> hColId;
  @FXML private TableColumn<InterventionRow, String> hColStatut, hColPanne, hColEntree, hColSortie;

  @FXML private Button btnClose;

  private final InterventionRepository interRepo = new InterventionRepository();
  private final ProductRepository productRepo = new ProductRepository();
  private FilteredList<ProductRow> filteredProducts;
  private FilteredList<InterventionRow> filteredInterventions;

  private Long currentProductId; // produit courant (panneau de droite)

  private boolean isClosed(InterventionRow r) {
    if (r == null) return false;
    String ds = r.dateSortie();
    return ds != null && !ds.trim().isEmpty();
  }

  @FXML
  private void initialize() {
    // Configuration de la table des produits
    colProdNom.setCellValueFactory(cd -> new ReadOnlyStringWrapper(cd.getValue().nom()));
    colProdCode.setCellValueFactory(cd -> new ReadOnlyStringWrapper(cd.getValue().code()));
    colProdFabricant.setCellValueFactory(cd -> new ReadOnlyStringWrapper(cd.getValue().fabricant()));
    colProdSituation.setCellValueFactory(cd -> new ReadOnlyStringWrapper(cd.getValue().situation()));

    // Configuration de la table d'historique des interventions
    colId.setCellValueFactory(cd -> new ReadOnlyObjectWrapper<>(cd.getValue().id()));
    colStatut.setCellValueFactory(cd -> new ReadOnlyStringWrapper(cd.getValue().statut()));
    colPanne.setCellValueFactory(cd -> new ReadOnlyStringWrapper(cd.getValue().panne()));
    colEntree.setCellValueFactory(cd -> new ReadOnlyStringWrapper(cd.getValue().dateEntree()));
    colSortie.setCellValueFactory(cd -> new ReadOnlyStringWrapper(cd.getValue().dateSortie()));

    // Configuration de la table d'historique dans le panneau de droite
    hColId.setCellValueFactory(cd -> new ReadOnlyObjectWrapper<>(cd.getValue().id()));
    hColStatut.setCellValueFactory(cd -> new ReadOnlyStringWrapper(cd.getValue().statut()));
    hColPanne.setCellValueFactory(cd -> new ReadOnlyStringWrapper(cd.getValue().panne()));
    hColEntree.setCellValueFactory(cd -> new ReadOnlyStringWrapper(cd.getValue().dateEntree()));
    hColSortie.setCellValueFactory(cd -> new ReadOnlyStringWrapper(cd.getValue().dateSortie()));

    // Masquer le bouton Clôturer
    if (btnClose != null) { btnClose.setVisible(false); btnClose.setManaged(false); }

    // Gérer la sélection de produit
    productTable.getSelectionModel().selectedItemProperty().addListener((obs, oldSel, newSel) -> {
      updateProductSelection(newSel);
    });

    // Gérer la sélection d'intervention dans l'historique
    table.getSelectionModel().selectedItemProperty().addListener((obs, oldSel, newSel) -> {
      updateRightPanelFromSelection(newSel);
    });

    // Recherche de produits
    if (productSearchField != null) {
      productSearchField.textProperty().addListener((obs, o, n) -> applyProductFilter());
    }

    // Styles pour la table des produits
    productTable.setRowFactory(tv -> {
      TableRow<ProductRow> r = new TableRow<>();
      r.setOnMouseClicked(e -> {
        if (!r.isEmpty() && e.getButton() == MouseButton.PRIMARY && e.getClickCount() == 2) {
          var product = r.getItem();
          Views.openProductSheet(product.id());
        }
      });
      return r;
    });

    // Styles pour la table d'historique
    table.setRowFactory(tv -> {
      TableRow<InterventionRow> r = new TableRow<>();
      ChangeListener<Object> restyle = (obs, o, n) -> applyRowStyle(r);
      r.itemProperty().addListener(restyle);
      r.selectedProperty().addListener(restyle);
      applyRowStyle(r);
      return r;
    });

    // Raccourcis clavier
    table.sceneProperty().addListener((obs, os, scene) -> {
      if (scene != null) {
        scene.getAccelerators().put(new KeyCodeCombination(KeyCode.F5), this::onRefresh);
      }
    });

    onRefresh();
  }    // Historique: même logique de style + double-clic
    historyTable.setRowFactory(tv -> {
      TableRow<InterventionRow> r = new TableRow<>();
      ChangeListener<Object> restyle = (obs, o, n) -> applyRowStyle(r);
      r.itemProperty().addListener(restyle);
      r.selectedProperty().addListener(restyle);
      r.setOnMouseClicked(e -> {
        if (!r.isEmpty() && e.getButton() == MouseButton.PRIMARY && e.getClickCount() == 2) {
          if (currentProductId != null) Views.openProductSheet(currentProductId);
        }
      });
      applyRowStyle(r);
      return r;
    });

    // Filtre live
    if (searchField != null) {
      searchField.textProperty().addListener((obs, o, n) -> applyFilter());
    }

    // Raccourcis
    table.sceneProperty().addListener((obs, os, scene) -> {
      if (scene == null) return;
      scene.getAccelerators().put(
          new KeyCodeCombination(KeyCode.ENTER),
          () -> {
            var sel = table.getSelectionModel().getSelectedItem();
            if (sel != null) productRepo.findByInterventionId(sel.id()).ifPresent(p -> Views.openProductSheet(p.id()));
          });
    });

    onRefresh();
  }

  private void updateRightPanelFromSelection(InterventionRow row) {
    if (row == null) { clearRightPanel(); return; }
    var pOpt = productRepo.findByInterventionId(row.id());
    if (pOpt.isEmpty()) { clearRightPanel(); return; }
    var p = pOpt.get();
    currentProductId = p.id();
    if (lblProdName != null) lblProdName.setText(nz(p.nom()));
    if (lblProdCode != null) lblProdCode.setText(nz(p.code()));
    if (lblProdSN != null) lblProdSN.setText(nz(p.sn()));
    if (lblProdUID != null) lblProdUID.setText(nz(p.uid()));
    if (lblProdManufacturer != null) lblProdManufacturer.setText(nz(p.fabricant()));
    if (lblProdSituation != null) lblProdSituation.setText(nz(p.situation()));
    if (historyTable != null) {
      List<InterventionRow> hist = interRepo.findByProductId(p.id());
      historyTable.setItems(FXCollections.observableArrayList(hist));
    }
  }

  @FXML
  private void onRefresh() {
    // Conserver la sélection courante (si possible)
    Long selectedId = null;
    var sel = table.getSelectionModel().getSelectedItem();
    if (sel != null) selectedId = sel.id();

    System.out.println("DEBUG: Démarrage refresh...");
    List<InterventionRow> rows = interRepo.findAllWithProductName();
    System.out.println("DEBUG: Requête terminée, " + rows.size() + " lignes récupérées");
    for (int i = 0; i < Math.min(3, rows.size()); i++) {
      var r = rows.get(i);
      System.out.println("DEBUG: Ligne " + i + ": ID=" + r.id() + ", Produit=" + r.produitNom() + ", Statut=" + r.statut());
    }
    
    if (Boolean.getBoolean("magsav.debug") || "1".equals(System.getenv("MAGSAV_DEBUG"))) {
      System.out.println("[MAGSAV] onRefresh -> " + rows.size() + " lignes");
    }
    filtered = new FilteredList<>(FXCollections.observableArrayList(rows), r -> true);
    SortedList<InterventionRow> sorted = new SortedList<>(filtered);
    sorted.comparatorProperty().bind(table.comparatorProperty());
    table.setItems(sorted);
    System.out.println("DEBUG: Table setItems terminé, table.getItems().size() = " + table.getItems().size());
    applyFilter();

    // Si vide: vider le panneau de droite et l’historique
    if (table.getItems() == null || table.getItems().isEmpty()) {
      clearRightPanel();
      return;
    }
    // Réappliquer la sélection ou sélectionner la première
    if (selectedId != null) {
      int idx = -1;
      for (int i = 0; i < table.getItems().size(); i++) {
        if (table.getItems().get(i).id() == selectedId) { idx = i; break; }
      }
      if (idx >= 0) table.getSelectionModel().select(idx);
      else table.getSelectionModel().selectFirst();
    } else {
      table.getSelectionModel().selectFirst();
    }
    // Forcer la mise à jour du panneau de droite après sélection
    updateRightPanelFromSelection(table.getSelectionModel().getSelectedItem());
  }

  private void clearRightPanel() {
    currentProductId = null;
    if (lblProdName != null) lblProdName.setText("");
    if (lblProdCode != null) lblProdCode.setText("");
    if (lblProdSN != null) lblProdSN.setText("");
    if (lblProdUID != null) lblProdUID.setText("");
    if (lblProdManufacturer != null) lblProdManufacturer.setText("");
    if (lblProdSituation != null) lblProdSituation.setText("");
    if (historyTable != null) historyTable.setItems(FXCollections.observableArrayList());
  }

  @FXML private void onClearSearch() { if (searchField != null) searchField.clear(); }

  // Simplifié: onNewIntervention non implémenté dans cette build
  @FXML
  private void onNewIntervention() {
    var row = table.getSelectionModel().getSelectedItem();
    if (row == null) {
      new Alert(Alert.AlertType.WARNING, "Sélectionnez d’abord une intervention/produit.").showAndWait();
      return;
    }
    // Crée une nouvelle intervention pour le même produit que la ligne sélectionnée
    var prodOpt = productRepo.findByInterventionId(row.id());
    if (prodOpt.isEmpty()) {
      new Alert(Alert.AlertType.ERROR, "Produit introuvable pour la sélection.").showAndWait();
      return;
    }
    var product = prodOpt.get();
    long pid = product.id();
    long iid = interRepo.insert(pid, product.sn(), null, "Créée depuis l’écran principal");
    if (iid > 0) {
      Views.openInterventionDetail(iid, product);
      onRefresh();
    } else {
      new Alert(Alert.AlertType.ERROR, "Échec de création de l’intervention").showAndWait();
    }
  }

  @FXML
  private void onCloseIntervention() {
    var sel = table.getSelectionModel().getSelectedItem();
    if (sel == null) {
      new Alert(Alert.AlertType.WARNING, "Sélectionnez une intervention.").showAndWait();
      return;
    }
    if (isClosed(sel)) {
      new Alert(Alert.AlertType.INFORMATION, "Cette intervention est déjà clôturée.").showAndWait();
      return;
    }
    int idx = table.getSelectionModel().getSelectedIndex();
    boolean ok = interRepo.close(sel.id());
    if (!ok) {
      new Alert(Alert.AlertType.ERROR, "Échec de clôture.").showAndWait();
      return;
    }
    onRefresh();
    if (idx >= 0 && idx < table.getItems().size()) {
      table.getSelectionModel().select(idx);
    }
  }

  // Alias pour compatibilité FXML (si onAction="#onCloseSelected")
  @FXML
  private void onCloseSelected() { onCloseIntervention(); }

  @FXML
  private void onImportCsv() {
    var chooser = new FileChooser();
    chooser.setTitle("Importer des interventions depuis un CSV");
    chooser.getExtensionFilters().addAll(
        new FileChooser.ExtensionFilter("CSV", "*.csv"),
        new FileChooser.ExtensionFilter("Tous les fichiers", "*.*"));
    var owner = table != null && table.getScene() != null ? table.getScene().getWindow() : null;
    var file = chooser.showOpenDialog(owner);
    if (file == null) return;

    // Afficher les colonnes acceptées
    String helpMsg = "Colonnes reconnues (utiliser l'une de ces variantes):\n" +
        "• produit (product, nom_produit, nom, libelle)\n" +
        "• no_de_serie (sn, serial, n_serie, numero_serie)\n" +
        "• proprietaire (owner, client, societe)\n" +
        "• panne (defaut, probleme, description)\n" +
        "• status (statut, etat_intervention)\n" +
        "• detecteur (detector, technicien)\n" +
        "• date_entree (entree, date_debut)\n" +
        "• date_sortie (sortie, date_fin)\n" +
        "• no_suivi (n_suivi, tracking)\n\n" +
        "Continuer l'import ?";
    
    var helpAlert = new Alert(Alert.AlertType.CONFIRMATION, helpMsg);
    helpAlert.setHeaderText("Format CSV");
    if (helpAlert.showAndWait().orElse(ButtonType.CANCEL) == ButtonType.CANCEL) return;

    ButtonType simBtn = new ButtonType("Simulation", ButtonBar.ButtonData.LEFT);
    ButtonType runBtn = new ButtonType("Importer", ButtonBar.ButtonData.OK_DONE);
    ButtonType cancelBtn = new ButtonType("Annuler", ButtonBar.ButtonData.CANCEL_CLOSE);
    var ask = new Alert(Alert.AlertType.CONFIRMATION, "Voulez-vous exécuter une simulation (aucune écriture) ou importer ?", runBtn, simBtn, cancelBtn);
    ask.setHeaderText("Import CSV");
    var choice = ask.showAndWait().orElse(cancelBtn);
    if (choice == cancelBtn) return;
    boolean dryRun = (choice == simBtn);

    try {
      CsvImporter importer = new CsvImporter();
      var result = importer.importFile(file.toPath(), dryRun);
      String msg = (result.dryRun() ? "[Simulation]\n" : "")
          + "Lignes lues: " + result.rowsRead() + "\n"
          + "Interventions créées: " + result.interventionsCreated() + "\n"
          + "Produits créés: " + result.productsCreated();
      if (!result.errors().isEmpty()) msg += "\n\nErreurs:\n" + String.join("\n", result.errors());
      new Alert(result.errors().isEmpty() ? Alert.AlertType.INFORMATION : Alert.AlertType.WARNING, msg).showAndWait();
      if (!dryRun) onRefresh();
    } catch (Exception e) {
      new Alert(Alert.AlertType.ERROR, "Échec import: " + e.getMessage()).showAndWait();
      e.printStackTrace();
    }
  }

  @FXML
  private void onImportMedia() {
    // Choisir le type de média
    var typeChoice = new Alert(Alert.AlertType.CONFIRMATION);
    typeChoice.setTitle("Type de média");
    typeChoice.setHeaderText("Quel type de fichier souhaitez-vous importer ?");
    typeChoice.setContentText("Choisissez le type de média à importer:");
    
    var photosButton = new ButtonType("Photos");
    var logosButton = new ButtonType("Logos");
    var cancelButton = new ButtonType("Annuler", ButtonBar.ButtonData.CANCEL_CLOSE);
    
    typeChoice.getButtonTypes().setAll(photosButton, logosButton, cancelButton);
    
    var owner = table != null && table.getScene() != null ? table.getScene().getWindow() : null;
    var typeResult = typeChoice.showAndWait();
    
    if (typeResult.isEmpty() || typeResult.get() == cancelButton) return;
    
    var mediaType = typeResult.get() == photosButton ? 
        com.magsav.imports.MediaImporter.MediaType.PHOTOS : 
        com.magsav.imports.MediaImporter.MediaType.LOGOS;
    
    // Choisir les fichiers selon le type
    var chooser = new FileChooser();
    chooser.setTitle("Importer des " + mediaType.getFolderName());
    
    if (mediaType == com.magsav.imports.MediaImporter.MediaType.PHOTOS) {
      chooser.getExtensionFilters().addAll(
          new FileChooser.ExtensionFilter("Images Photos", "*.jpg", "*.jpeg", "*.png", "*.gif", "*.bmp", "*.tiff"),
          new FileChooser.ExtensionFilter("Tous les fichiers", "*.*"));
    } else {
      chooser.getExtensionFilters().addAll(
          new FileChooser.ExtensionFilter("Images Logos", "*.png", "*.svg", "*.jpg", "*.jpeg", "*.gif", "*.pdf"),
          new FileChooser.ExtensionFilter("Tous les fichiers", "*.*"));
    }
    
    var files = chooser.showOpenMultipleDialog(owner);
    if (files == null || files.isEmpty()) return;

    try {
      var importer = new com.magsav.imports.MediaImporter();
      var filePaths = files.stream().map(java.io.File::toPath).toList();
      var result = importer.importFiles(filePaths, mediaType);
      
      String msg = "Fichiers traités: " + result.filesProcessed() + "\n"
          + "Fichiers importés: " + result.filesImported() + "\n"
          + "Type: " + mediaType.getFolderName() + "\n"
          + "Répertoire: " + result.targetDirectory();
      
      if (!result.errors().isEmpty()) {
        msg += "\n\nErreurs:\n" + String.join("\n", result.errors());
      }
      
      new Alert(result.errors().isEmpty() ? Alert.AlertType.INFORMATION : Alert.AlertType.WARNING, msg).showAndWait();
    } catch (Exception e) {
      new Alert(Alert.AlertType.ERROR, "Échec import médias: " + e.getMessage()).showAndWait();
      e.printStackTrace();
    }
  }

  // Ouvre une fenêtre à partir d’un FXML
  private void openWindow(String title, String fxmlPath) {
    try {
      var url = getClass().getResource(fxmlPath);
      if (url == null) {
        new Alert(Alert.AlertType.ERROR, "FXML introuvable: " + fxmlPath).showAndWait();
        return;
      }
      Parent root = FXMLLoader.load(url);
      Stage stage = new Stage();
      stage.setTitle(title);
      stage.setScene(new Scene(root));
      stage.show();
    } catch (Exception e) {
      new Alert(Alert.AlertType.ERROR, "Erreur d’ouverture: " + e.getMessage()).showAndWait();
    }
  }

  // Handlers appelés par main.fxml
  @FXML private void onOpenCategories()    { try { Router.open(Router.Route.CATEGORIES); } catch (Exception e) { alertOpen(e); } }
  @FXML private void onOpenManufacturers() { try { Router.open(Router.Route.MANUFACTURERS); } catch (Exception e) { alertOpen(e); } }
  @FXML private void onOpenSuppliers()     { try { Router.open(Router.Route.SUPPLIERS); } catch (Exception e) { alertOpen(e); } }
  @FXML private void onOpenExternalSav()   { try { Router.open(Router.Route.EXTERNAL_SAV); } catch (Exception e) { alertOpen(e); } }
  @FXML private void onOpenClients()       { try { Router.open(Router.Route.CLIENTS); } catch (Exception e) { alertOpen(e); } }
  @FXML private void onOpenPartRequests()      { try { Router.open(Router.Route.REQ_PARTS); } catch (Exception e) { alertOpen(e); } }
  @FXML private void onOpenEquipmentRequests() { try { Router.open(Router.Route.REQ_EQUIP); } catch (Exception e) { alertOpen(e); } }

  private void alertOpen(Exception e) {
    new Alert(Alert.AlertType.ERROR, "Erreur d’ouverture: " + e.getMessage()).showAndWait();
  }

  // Filtre la table selon le champ de recherche
  private void applyFilter() {
    if (filtered == null) return;
    String q = (searchField == null) ? "" : searchField.getText();
    String s = (q == null) ? "" : q.trim().toLowerCase();
    if (s.isEmpty()) { filtered.setPredicate(r -> true); return; }
    filtered.setPredicate(r ->
      r != null && (
        (r.produitNom() != null && r.produitNom().toLowerCase().contains(s)) ||
        (r.statut() != null && r.statut().toLowerCase().contains(s)) ||
        (r.panne() != null && r.panne().toLowerCase().contains(s)) ||
        (r.dateEntree() != null && r.dateEntree().toLowerCase().contains(s)) ||
        (r.dateSortie() != null && r.dateSortie().toLowerCase().contains(s)) ||
        String.valueOf(r.id()).contains(s)
      )
    );
  }
  // Menus placeholders (pour compiler)
  @FXML private void onMenuUsers(ActionEvent e) {}
  @FXML private void onMenuAdmins(ActionEvent e) {}
  @FXML private void onMenuCategories(ActionEvent e) {}
  @FXML private void onMenuSubcategories(ActionEvent e) {}
  @FXML private void onMenuAssignManufacturers(ActionEvent e) {}
  @FXML private void onMenuProducts(ActionEvent e) {}
  @FXML private void onMenuManufacturers(ActionEvent e) {}
  @FXML private void onMenuSuppliers(ActionEvent e) {}
  @FXML private void onMenuExternalSav(ActionEvent e) {}
  @FXML private void onMenuClients(ActionEvent e) {}
  @FXML private void onMenuPartRequests(ActionEvent e) {}
  @FXML private void onMenuEquipmentRequests(ActionEvent e) {}
  @FXML private void onMenuPreferences(ActionEvent e) {}
  @FXML private void onMenuAdvancedConfig(ActionEvent e) {}
  @FXML private void onMenuDbSettings(ActionEvent e) {}
  @FXML private void onMenuQuit(ActionEvent e) { Platform.exit(); }

  // Ouvre la fiche produit dans une nouvelle fenêtre
  private void openProductSheet(long productId) {
    try {
      FXMLLoader loader = new FXMLLoader(getClass().getResource("/fxml/product_detail.fxml"));
      Parent root = loader.load();
      com.magsav.gui.product.ProductDetailController ctl = loader.getController();
      ctl.setProductId(productId);
      Stage stage = new Stage();
      stage.setTitle("Fiche produit #" + productId);
      stage.setScene(new Scene(root));
      stage.show();
    } catch (Exception e) {
      StringBuilder sb = new StringBuilder("Ouverture fiche produit: ")
          .append(e.getClass().getSimpleName()).append(": ").append(nz(e.getMessage()));
      Throwable c = e.getCause();
      while (c != null) {
        sb.append("\nCaused by ").append(c.getClass().getSimpleName()).append(": ").append(nz(c.getMessage()));
        c = c.getCause();
      }
      System.err.println("[MAGSAV] " + sb);
      // Trace complète pour obtenir la ligne du FXML fautive
      e.printStackTrace();
      if (e.getCause() != null) e.getCause().printStackTrace();
      new Alert(Alert.AlertType.ERROR, "Ouverture fiche produit: " + e.getMessage()).showAndWait();
    }
  }

  private void copyRowToClipboard(InterventionRow r) {
    String txt = r.id() + " | " +
        nz(r.produitNom()) + " | " + nz(r.statut()) + " | " + nz(r.panne()) +
        " | " + nz(r.dateEntree()) + " -> " + nz(r.dateSortie());
    ClipboardContent cc = new ClipboardContent();
    cc.putString(txt);
    Clipboard.getSystemClipboard().setContent(cc);
  }

  private void exportFilteredCsv() {
    var items = table.getItems(); // SortedList basé sur le filtre courant
    if (items == null || items.isEmpty()) {
      new Alert(Alert.AlertType.INFORMATION, "Aucune donnée à exporter.").showAndWait();
      return;
    }
    FileChooser fc = new FileChooser();
    fc.setTitle("Exporter les interventions (CSV)");
    fc.getExtensionFilters().add(new FileChooser.ExtensionFilter("CSV", "*.csv"));
    fc.setInitialFileName("interventions.csv");
    var owner = table != null && table.getScene() != null ? table.getScene().getWindow() : null;
    var file = fc.showSaveDialog(owner);
    if (file == null) return;
    try (var w = java.nio.file.Files.newBufferedWriter(file.toPath(), java.nio.charset.StandardCharsets.UTF_8)) {
      // En-tête
      w.write("id;produit;statut;panne;date_entree;date_sortie");
      w.newLine();
      for (var r : items) {
        w.write(csv(String.valueOf(r.id()))); w.write(';');
        w.write(csv(r.produitNom())); w.write(';');
        w.write(csv(r.statut())); w.write(';');
        w.write(csv(r.panne())); w.write(';');
        w.write(csv(r.dateEntree())); w.write(';');
        w.write(csv(r.dateSortie()));
        w.newLine();
      }
    } catch (Exception ex) {
      new Alert(Alert.AlertType.ERROR, "Export échoué: " + ex.getMessage()).showAndWait();
      return;
    }
    new Alert(Alert.AlertType.INFORMATION, "Export terminé: " + file.getAbsolutePath()).showAndWait();
  }

  private static String csv(String s) {
    if (s == null) return "";
    String v = s.replace("\r", " ").replace("\n", " ");
    if (v.contains(";") || v.contains("\"")) {
      v = "\"" + v.replace("\"", "\"\"") + "\"";
    }
    return v;
  }

  private static String nz(String s) { return s == null ? "" : s; }

  private void applyRowStyle(TableRow<InterventionRow> r) {
    var item = r.getItem();
    if (item == null) { r.setStyle(""); return; }
    // Pas de style si sélectionnée (laisser le thème gérer fond/texte)
    if (r.isSelected()) { r.setStyle(""); return; }
    // Fond vert pâle pour interventions clôturées
    r.setStyle(isClosed(item) ? "-fx-background-color: rgba(0,128,0,0.08);" : "");
  }
}
