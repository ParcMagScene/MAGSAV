<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAGSAV - Gestion SAV</title>
    <link th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/webjars/fortawesome__fontawesome-free/css/all.min.css}" rel="stylesheet">
    <link th:href="@{/css/index.css}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container d-flex align-items-center">
            <!-- Logo en haut à gauche servant d'accès au menu -->
            <div class="dropdown me-3">
                <a class="navbar-brand dropdown-toggle d-flex align-items-center" href="#" data-bs-toggle="dropdown">
                    <span class="brand-avatar me-2"><i class="fas fa-tools"></i></span>
                    <span>MAGSAV</span>
                </a>
                <ul class="dropdown-menu">
                    <li class="dropdown-header">Menu</li>
                    <li><a class="dropdown-item" href="/">
                        <i class="fas fa-home"></i> Accueil
                    </a></li>
                    <li><hr class="dropdown-divider"/></li>
                    <li class="dropdown-submenu dropend">
                        <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            <i class="fas fa-file-import"></i> Import / Export
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/import/advanced"><i class="fas fa-star"></i> Interface avancée</a></li>
                            <li><a class="dropdown-item" href="/import"><i class="fas fa-upload"></i> Interface classique</a></li>
                        </ul>
                    </li>
                    <li class="dropdown-submenu dropend" sec:authorize="hasRole('ADMIN')">
                        <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            <i class="fas fa-gear"></i> Configuration
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-users"></i> Utilisateurs</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user-shield"></i> Administrateur</a></li>
                            <li><a class="dropdown-item" href="/categories"><i class="fas fa-tags"></i> Catégories</a></li>
                        </ul>
                    </li>
                </ul>
            </div>

            <div class="ms-auto navbar-nav d-flex align-items-center">
                <a class="nav-link" href="/dossier/nouveau" sec:authorize="hasRole('ADMIN')">
                    <i class="fas fa-plus-circle"></i> Nouvelle intervention
                </a>
                <div sec:authorize="isAuthenticated()" class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i> <span sec:authentication="name">Utilisateur</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/profile"><i class="fas fa-id-card"></i> Mon profil</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form th:action="@{/logout}" method="post" class="d-inline">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button type="submit" class="dropdown-item"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
                            </form>
                        </li>
                    </ul>
                </div>
                <div sec:authorize="isAnonymous()">
                    <a class="nav-link" href="/login">
                        <i class="fas fa-sign-in-alt"></i> Connexion
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Encart développeur (visible seulement pour ADMIN) -->
        <div class="alert alert-info d-flex align-items-start" sec:authorize="hasRole('ADMIN')">
            <div class="me-2"><i class="fas fa-terminal"></i></div>
            <div>
                <strong>Astuce dev:</strong> démarrer/arrêter rapidement depuis la racine du projet
                <div class="mt-1 small">
                    <code>scripts/start-all.sh</code> pour lancer Web + JavaFX<br/>
                    <code>scripts/stop-web.sh</code> pour arrêter le serveur Web
                </div>
                <div class="mt-1 small text-muted">
                    Logs: <code>build/logs/web.log</code> · PID: <code>.web.pid</code>
                </div>
            </div>
        </div>
        <!-- Messages d'alerte (depuis modèle ou query params) -->
        <div th:if="${success != null or param.success != null}" class="alert alert-success alert-dismissible fade show">
            <span th:text="${success != null ? success : (param.success != null ? param.success[0] : '')}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error != null or param.error != null}" class="alert alert-danger alert-dismissible fade show">
            <span th:text="${error != null ? error : (param.error != null ? param.error[0] : '')}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Statistiques -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stats-card stats-recu">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-inbox"></i> Reçus
                        </h5>
                        <h2 class="text-primary" th:text="${statsRecus ?: 0}">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card stats-en_cours">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-cog"></i> En cours
                        </h5>
                        <h2 class="text-warning" th:text="${statsEnCours ?: 0}">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card stats-termine">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-check"></i> Terminés
                        </h5>
                        <h2 class="text-success" th:text="${statsTermines ?: 0}">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cadre Produits avec barre de recherche -->
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-box me-2"></i>
                <strong>Produits</strong>
                <span class="badge bg-secondary ms-2" th:text="${productsTotal ?: 0}">0</span>
            </div>
            <div class="card-body">
                <form method="get" action="/" class="row g-2 mb-3">
                    <input type="hidden" name="view" value="products" />
                    <div class="col-md-3">
                        <input class="form-control" name="p_produit" th:value="${p_produit}" placeholder="Nom du produit"/>
                    </div>
                    <div class="col-md-3">
                        <input class="form-control" name="p_sn" th:value="${p_sn}" placeholder="Numéro de série"/>
                    </div>
                    <div class="col-md-2">
                        <input class="form-control" name="p_code" th:value="${p_code}" placeholder="Code unique"/>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" name="p_categoryId">
                            <option value="" th:selected="${p_categoryId == null}">Toutes catégories</option>
                            <option th:each="c : ${categoriesRoots}" th:value="${c.id}" th:text="${c.name}"
                                    th:selected="${p_categoryId != null and p_categoryId == c.id}"></option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" name="p_subcategoryId">
                            <option value="" th:selected="${p_subcategoryId == null}">Toutes sous-catégories</option>
                            <option th:each="c : ${p_children}" th:value="${c.id}" th:text="${c.name}"
                                    th:selected="${p_subcategoryId != null and p_subcategoryId == c.id}"></option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" name="p_statut">
                            <option value="" th:selected="${p_statut == null || p_statut == ''}">Tous statuts</option>
                            <option th:value="recu" th:selected="${p_statut == 'recu'}">Reçu</option>
                            <option th:value="en_cours" th:selected="${p_statut == 'en_cours'}">En cours</option>
                            <option th:value="termine" th:selected="${p_statut == 'termine'}">Terminé</option>
                        </select>
                    </div>
                    <div class="col-md-2 text-end">
                        <button class="btn btn-outline-primary" type="submit"><i class="fas fa-search"></i> Rechercher</button>
                    </div>
                </form>
                <div class="table-responsive" th:if="${products != null and !products.empty}">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Photo</th>
                                <th>Produit</th>
                                <th>N° Série</th>
                                <th>Interventions</th>
                                <th>Dernière entrée</th>
                                <th>Dernière sortie</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="p : ${products}">
                          <td class="w-72px">
                                    <img th:if="${p.numeroSerie != null and !#strings.isEmpty(p.numeroSerie)}"
                                         th:src="@{'/product/' + ${p.numeroSerie} + '/photo'}" alt="photo"
                                 class="img-thumbnail thumb-64-cover"/>
                                    <div th:if="${p.numeroSerie == null or #strings.isEmpty(p.numeroSerie)}"
                                         class="text-muted">—</div>
                                </td>
                                <td th:text="${p.produit}">Produit</td>
                                <td><code th:text="${p.numeroSerie != null and !#strings.isEmpty(p.numeroSerie) ? p.numeroSerie : '-'}">-</code></td>
                                <td><span class="badge bg-secondary" th:text="${p.interventionsCount}">0</span></td>
                                <td th:text="${p.lastDateEntree != null ? #temporals.format(p.lastDateEntree, 'dd/MM/yyyy') : '-'}">-</td>
                                <td th:text="${p.lastDateSortie != null ? #temporals.format(p.lastDateSortie, 'dd/MM/yyyy') : '-'}">-</td>
                                <td>
                                    <div sec:authorize="hasRole('ADMIN')" th:if="${p.numeroSerie != null and !#strings.isEmpty(p.numeroSerie)}">
                                        <form th:action="@{'/product/' + ${p.numeroSerie} + '/photo'}" method="post" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                            <input type="file" name="file" accept="image/*" class="form-control form-control-sm" />
                                            <button type="submit" class="btn btn-sm btn-outline-secondary"><i class="fas fa-upload"></i></button>
                                        </form>
                                    </div>
                                    <div class="text-muted small" sec:authorize="!hasRole('ADMIN')">—</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${products == null || products.empty}" class="text-muted">Aucun produit trouvé.</div>
            </div>
        </div>

        <!-- Cadre Interventions avec recherches et filtres -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="m-0">
                <i class="fas fa-screwdriver-wrench"></i> Interventions SAV
                <span class="badge bg-secondary" th:text="${totalDossiers ?: 0}">0</span>
            </h2>
            <div>
                <a href="/dossier/nouveau" class="btn btn-success me-2" sec:authorize="hasRole('ADMIN')">
                    <i class="fas fa-plus-circle"></i> Nouvelle intervention
                </a>
                <a href="/" class="btn btn-outline-primary">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </a>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-body">
                <form method="get" action="/" class="row g-2">
                    <input type="hidden" name="view" value="interventions" />
                    <div class="col-md-2"><input class="form-control" name="i_produit" th:value="${i_produit}" placeholder="Produit"/></div>
                    <div class="col-md-2"><input class="form-control" name="i_sn" th:value="${i_sn}" placeholder="N° Série"/></div>
                    <div class="col-md-2"><input class="form-control" name="i_code" th:value="${i_code}" placeholder="Code"/></div>
                    <div class="col-md-2">
                        <select class="form-select" name="i_statut">
                            <option value="" th:selected="${i_statut == null || i_statut == ''}">Tous statuts</option>
                            <option th:value="recu" th:selected="${i_statut == 'recu'}">Reçu</option>
                            <option th:value="en_cours" th:selected="${i_statut == 'en_cours'}">En cours</option>
                            <option th:value="termine" th:selected="${i_statut == 'termine'}">Terminé</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" name="i_categoryId">
                            <option value="" th:selected="${i_categoryId == null}">Toutes catégories</option>
                            <option th:each="c : ${categoriesRoots}" th:value="${c.id}" th:text="${c.name}"
                                    th:selected="${i_categoryId != null and i_categoryId == c.id}"></option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" name="i_subcategoryId">
                            <option value="" th:selected="${i_subcategoryId == null}">Toutes sous-catégories</option>
                            <option th:each="c : ${i_children}" th:value="${c.id}" th:text="${c.name}"
                                    th:selected="${i_subcategoryId != null and i_subcategoryId == c.id}"></option>
                        </select>
                    </div>
                    <div class="col-md-2"><input type="date" class="form-control" name="i_entree_from" th:value="${i_entree_from}" placeholder="Entrée de"/></div>
                    <div class="col-md-2"><input type="date" class="form-control" name="i_entree_to" th:value="${i_entree_to}" placeholder="Entrée à"/></div>
                    <div class="col-md-2"><input type="date" class="form-control" name="i_sortie_from" th:value="${i_sortie_from}" placeholder="Sortie de"/></div>
                    <div class="col-md-2"><input type="date" class="form-control" name="i_sortie_to" th:value="${i_sortie_to}" placeholder="Sortie à"/></div>
                    <div class="col-md-2 text-end ms-auto">
                        <button class="btn btn-outline-primary" type="submit"><i class="fas fa-search"></i> Filtrer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Titre et compteur -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>
                <i class="fas fa-screwdriver-wrench"></i> Interventions SAV
                <span class="badge bg-secondary" th:text="${totalDossiers ?: 0}">0</span>
            </h2>
            <div>
                <a href="/dossier/nouveau" class="btn btn-success me-2" sec:authorize="hasRole('ADMIN')">
                    <i class="fas fa-plus-circle"></i> Nouvelle intervention
                </a>
                <a href="/" class="btn btn-outline-primary">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </a>
            </div>
        </div>

        <!-- Table des interventions -->
        <div class="card">
            <div class="card-body">
                <div th:if="${dossiers != null and !dossiers.empty}" class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Code</th>
                                <th>ID</th>
                                <th>Propriétaire</th>
                                <th>Produit</th>
                                <th>N° Série</th>
                                <th>Problème</th>
                                <th>Statut</th>
                                <th>Date entrée</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="dossier : ${dossiers}">
                                <td>
                                    <span class="badge bg-dark"
                                          th:text="${!#strings.isEmpty(dossier.code) ? #strings.toUpperCase(dossier.code) : '-'}">-</span>
                                </td>
                                <td>
                                    <strong th:text="${dossier.id}">1</strong>
                                </td>
                                <td th:text="${dossier.proprietaire}">Jean Dupont</td>
                                <td th:text="${dossier.produit}">iPhone 14</td>
                                <td>
                                    <code th:text="${!#strings.isEmpty(dossier.numeroSerie) ? dossier.numeroSerie : '-'}">-</code>
                                </td>
                                <td th:text="${#strings.abbreviate(dossier.panne, 50)}">Écran cassé</td>
                                <td>
                                    <span class="badge status-badge" 
                                          th:classappend="${'status-' + dossier.statut}"
                                          th:text="${dossier.statut}">recu</span>
                                </td>
                                <td th:text="${dossier.dateEntree != null ? #temporals.format(dossier.dateEntree, 'dd/MM/yyyy') : '-'}">-</td>
                                <td>
                                    <a th:href="@{/intervention/{id}(id=${dossier.id})}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> Voir
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${dossiers == null or dossiers.empty}" class="text-center py-5">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Aucune intervention trouvée</h4>
                    <p class="text-muted">Commencez par importer des données CSV ou créez une nouvelle intervention.</p>
                    <a href="/import" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Importer des données
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
</body>
</html>