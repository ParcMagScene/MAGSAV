plugins {
    id 'java'
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.0.14'
    id 'org.springframework.boot' version '3.1.5'
    id 'io.spring.dependency-management' version '1.1.6'
    id 'com.github.spotbugs' version '6.0.27'
    id 'checkstyle'
    id 'com.diffplug.spotless' version '6.25.0'
    id "org.openrewrite.rewrite" version "6.28.0"
}

import com.github.spotbugs.snom.SpotBugsTask
import com.github.spotbugs.snom.Effort
import com.github.spotbugs.snom.Confidence

group = 'com.magsav'
version = '1.1.0'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

tasks.withType(JavaExec).configureEach {
    javaLauncher = javaToolchains.launcherFor { languageVersion = JavaLanguageVersion.of(21) }
}

repositories {
    // ...existing repositories...
    mavenCentral()
}

ext {
    zxingVersion = '3.5.3'
    sqliteVersion = '3.45.3.0'
    hikariVersion = '5.1.0'
    slf4jVersion = '2.0.13'
    pdfboxVersion = '2.0.31'
    opencsvVersion = '5.9'
    picocliVersion = '4.7.6'
}

javafx {
    version = '21.0.8'
    modules = ['javafx.controls', 'javafx.fxml']
}

dependencies {
    // Dépendances Spring Boot pour l'interface web
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity6'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
    testImplementation 'org.junit.jupiter:junit-jupiter-params:5.11.0'
    testImplementation 'org.assertj:assertj-core:3.26.3'
    testImplementation 'org.mockito:mockito-core:5.12.0'
    // Déclarer explicitement le moteur de tests JUnit Jupiter pour Gradle 9
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine'

    // WebJars pour servir Bootstrap localement (CSS/JS) sans CDN
    implementation 'org.webjars:webjars-locator-core:0.52'
    implementation 'org.webjars.npm:bootstrap:5.1.3'
    // WebJar pour Font Awesome (remplace le CDN)
    implementation 'org.webjars.npm:fortawesome__fontawesome-free:6.5.2'
    
    // Dépendances existantes du projet MAGSAV
    implementation "com.google.zxing:core:${zxingVersion}"
    implementation "com.google.zxing:javase:${zxingVersion}"
    implementation "org.xerial:sqlite-jdbc:${sqliteVersion}"
    implementation "com.zaxxer:HikariCP:${hikariVersion}"
    implementation "org.slf4j:slf4j-api:${slf4jVersion}"
    implementation "org.apache.pdfbox:pdfbox:${pdfboxVersion}"
    implementation "com.opencsv:opencsv:${opencsvVersion}"
    implementation "info.picocli:picocli:${picocliVersion}"
    annotationProcessor "info.picocli:picocli-codegen:${picocliVersion}"
    spotbugs "org.apache.commons:commons-lang3:3.17.0"

    // OpenRewrite (versions alignées et figées)
    rewrite platform("org.openrewrite:rewrite-bom:8.28.0")
    // Remplacez 2.x.y par la dernière version 2.x de Maven Central
    rewrite platform("org.openrewrite.recipe:rewrite-recipe-bom:2.x.y")
    rewrite "org.openrewrite:rewrite-java"
    rewrite "org.openrewrite.recipe:rewrite-static-analysis"
}

// Recettes Java pour OpenRewrite
rewrite {
  activeRecipe("org.openrewrite.staticanalysis.CommonStaticAnalysis")
}

application {
    mainClass = 'com.magsav.gui.MAGSAVApp'
    
    // Options JVM par défaut pour l'application JavaFX
    applicationDefaultJvmArgs = [
        // Système de rendu alternatif pour éviter NSTrackingRectTag
        '-Dprism.order=sw',
        '-Dprism.verbose=false',
        '-Dprism.forceGPU=false',
        '-Djavafx.animation.fullspeed=true',
        
        // Désactiver les optimisations problématiques sur macOS
        '-Dglass.accessible.force=false',
        '-Dcom.apple.macos.useScreenMenuBar=false',
        '-Djavafx.platform.macos.useInheritedChannels=false',
        
        // Configuration de mémoire
        '-Xms512m',
        '-Xmx1024m'
    ]
}

// Configuration pour lancer l'interface ligne de commande
tasks.register('runCli', JavaExec) {
    mainClass.set('com.magsav.cli.MAGSAVCli')
    classpath = sourceSets.main.runtimeClasspath
    group = 'application'
    description = 'Lance l\'interface ligne de commande'
}

// Configuration pour lancer l'interface graphique JavaFX
// Délègue à la tâche 'run' du plugin 'application' pour bénéficier
// de l'intégration JavaFX du plugin OpenJFX
tasks.register('runGui') {
    group = 'application'
    description = 'Lance l\'interface graphique JavaFX (délègue à :run)'
    dependsOn(tasks.named('run'))
}

// Alias pratique pour certains environnements/commandes
tasks.register('runFX') {
    group = 'application'
    description = 'Alias de :run pour lancer l\'UI JavaFX'
    dependsOn(tasks.named('run'))
}

tasks.register('smokeTestWeb', Exec) {
    group = 'verification'
    description = 'Exécute le mini smoke test Web (démarrage, index, login, QR).'
    workingDir projectDir
    commandLine 'bash', 'scripts/smoke-test.sh'
}

// Lance l’UI JavaFX en mode smoke (--smoke)
tasks.register('runSmoke', JavaExec) {
    mainClass.set('com.magsav.gui.MAGSAVApp')
    classpath = sourceSets.main.runtimeClasspath
    group = 'verification'
    description = 'Lance l’UI JavaFX en mode smoke (--smoke)'
    args = ['--smoke']
}

// Smoke test JavaFX (headless) via runSmoke
tasks.register('smokeTestGui') {
    group = 'verification'
    description = 'Exécute le mini smoke test JavaFX en mode headless'
    dependsOn(tasks.named('runSmoke'))
}

// Tâche de vérification JavaFX
tasks.register('checkFx') {
    group = 'verification'
    description = 'Lance le smoke test JavaFX (run --smoke)'
    dependsOn('smokeTestGui')
}

// Configuration pour lancer l'interface web Spring Boot
tasks.register('runWeb', JavaExec) {
    mainClass.set('com.magsav.web.MAGSAVWebApp')
    classpath = sourceSets.main.runtimeClasspath
    group = 'application'
    description = 'Lance l\'interface web Spring Boot'
    // Permettre de surcharger le port: ./gradlew runWeb -Pport=8081 ou SERVER_PORT=8081 ./gradlew runWeb
    doFirst {
        def p = project.findProperty('port') ?: System.getenv('SERVER_PORT')
        if (p) {
            systemProperty 'server.port', p
            println "➡️  runWeb: server.port=$p"
        }
    }
}

// Tâche Gradle pour arrêter le serveur web via le script
tasks.register('stopWeb', Exec) {
    group = 'application'
    description = 'Arrête le serveur web démarré en arrière-plan (scripts/stop-web.sh)'
    workingDir = project.projectDir
    def isWindows = System.getProperty('os.name').toLowerCase(java.util.Locale.ROOT).contains('win')
    if (isWindows) {
        commandLine 'cmd', '/c', 'scripts/stop-web.sh'
    } else {
        commandLine 'bash', 'scripts/stop-web.sh'
    }
}

// Tâche Gradle pour démarrer Web (bg) + JavaFX (fg) via script
tasks.register('startAll', Exec) {
    group = 'application'
    description = 'Démarre le serveur web (arrière-plan) puis l’UI JavaFX (scripts/start-all.sh)'
    workingDir = project.projectDir
    def isWindows = System.getProperty('os.name').toLowerCase(java.util.Locale.ROOT).contains('win')
    if (isWindows) {
        commandLine 'cmd', '/c', 'scripts/start-all.sh'
    } else {
        commandLine 'bash', 'scripts/start-all.sh'
    }
}

// Définition explicite des sources (utile pour certains IDEs quand ils perdent la config)
sourceSets {
    main {
        java {
            srcDirs = ['src/main/java']
        }
        resources {
            srcDirs = ['src/main/resources']
        }
    }
    test {
        java {
            srcDirs = ['src/test/java']
        }
        resources {
            srcDirs = ['src/test/resources']
        }
    }
}

// Forcer Gradle à écrire les classes où VS Code les attend
tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
}

// Configuration de tests compatible avec toutes les versions de l'éditeur
tasks.withType(Test).configureEach {
    useJUnitPlatform()
}

checkstyle {
    toolVersion = '10.17.0'
    configFile = file('config/checkstyle/checkstyle.xml')
    configProperties = [
        'checkstyle.suppressions.file': file('config/checkstyle/suppressions.xml').absolutePath
    ]
}

// Config SpotBugs
spotbugs {
    toolVersion = '4.8.6'
    // optionnel: ignoreFailures = false
}

tasks.withType(SpotBugsTask).configureEach {
    effort.set(com.github.spotbugs.snom.Effort.valueOf('MAX'))
    reportLevel.set(com.github.spotbugs.snom.Confidence.valueOf('LOW'))
}

tasks.register('lint') {
    group = 'verification'
    description = 'Analyse statique: Checkstyle + SpotBugs'
    dependsOn('checkstyleMain', 'checkstyleTest', 'spotbugsMain', 'spotbugsTest')
}

// Tâche de vérification end-to-end: build (avec tests) + smoke test web
tasks.register('checkAll') {
    group = 'verification'
    description = 'Build + tests unitaires + smoke test web'
    dependsOn('build')
    finalizedBy('smokeTestWeb')
}

// Variante rapide: build sans tests + smoke test (utile en dev rapide)
tasks.register('fastCheck') {
    group = 'verification'
    description = 'Build sans tests + smoke test web (rapide)'
    dependsOn('buildNoTests')
    finalizedBy('smokeTestWeb')
}

// Génère un rapport des dépréciations/problèmes Gradle
tasks.register('problemsReport') {
    group = 'verification'
    description = 'Génère le rapport des problèmes/dépréciations Gradle (build/reports/problems/problems-report.html)'
    dependsOn('problemsReportExec')
    doLast {
        println "Rapport: build/reports/problems/problems-report.html"
    }
}

// Assemble sans exécuter les tests (sans sous-invoquer Gradle)
tasks.register('buildNoTests') {
    group = 'build'
    description = 'Assemble le projet sans exécuter les tests'
    doFirst {
        tasks.withType(Test).configureEach { enabled = false }
    }
    dependsOn('clean', 'build')
}

// Exécution du build avec rapports de dépréciations (évite exec(Closure))
tasks.register('problemsReportExec', Exec) {
    group = 'verification'
    description = 'Exécute ./gradlew build --warning-mode all pour générer le rapport des problèmes'
    workingDir project.projectDir
    commandLine 'bash', '-lc', './gradlew build --warning-mode all --no-daemon || true'
}

tasks.register('openCheckstyleReport', Exec) {
    group = 'verification'
    description = 'Ouvre le rapport Checkstyle (main.html)'
    dependsOn('checkstyleMain')
    workingDir project.projectDir
    commandLine 'bash', '-lc', 'open build/reports/checkstyle/main.html'
}

spotless {
    java {
        googleJavaFormat('1.22.0')
        removeUnusedImports()
        trimTrailingWhitespace()
        endWithNewline()
        // indentWithSpaces(4) supprimé pour éviter les conflits avec google-java-format
    }
}

// Intégrer Spotless dans lint et check
tasks.named('lint') {
    dependsOn 'spotlessCheck'
}
tasks.named('check') {
    dependsOn 'spotlessCheck'
}

// Stabilise le classpath de SpotBugs (corrige NoSuchMethodError)
configurations.configureEach { cfg ->
    if (cfg.name.toLowerCase(java.util.Locale.ROOT).startsWith('spotbugs')) {
        cfg.resolutionStrategy {
            force 'org.apache.commons:commons-lang3:3.14.0'
            force 'org.apache.bcel:bcel:6.10.0'
        }
    }
}

tasks.named('run').configure {
    javaLauncher = javaToolchains.launcherFor { languageVersion = JavaLanguageVersion.of(21) }
}

// CPD via l'outil système 'cpd' (Homebrew)
def cpdOutDir = layout.buildDirectory.dir("reports/cpd")

tasks.register('cpdJava', Exec) {
    group = 'verification'
    description = 'Détecte les duplications Java (CPD)'
    doFirst { cpdOutDir.get().asFile.mkdirs() }
    // Ne pas échouer si CPD trouve des doublons (exit 4)
    ignoreExitValue = true
    commandLine 'bash', '-lc', '''
set -euo pipefail
if command -v cpd >/dev/null 2>&1; then
  CPD_CMD="cpd"
elif command -v pmd >/dev/null 2>&1; then
  CPD_CMD="pmd cpd"
elif [ -x "/opt/homebrew/opt/pmd/libexec/bin/pmd" ]; then
  CPD_CMD="/opt/homebrew/opt/pmd/libexec/bin/pmd cpd"
elif [ -x "/usr/local/opt/pmd/libexec/bin/pmd" ]; then
  CPD_CMD="/usr/local/opt/pmd/libexec/bin/pmd cpd"
else
  echo "PMD introuvable. Installez-le: brew install pmd et assurez que 'pmd' est dans le PATH."
  exit 0
fi
# Génère le rapport; si CPD renvoie 4 (doublons), on n’échoue pas le build
eval "$CPD_CMD --dir src/main/java --language java --minimum-tokens 75 --format text" > build/reports/cpd/cpd-java.txt || true
'''
}

tasks.register('cpdFxml', Exec) {
    group = 'verification'
    description = 'Détecte les duplications FXML (CPD XML)'
    doFirst { cpdOutDir.get().asFile.mkdirs() }
    // Ne pas échouer si CPD renvoie 4
    ignoreExitValue = true
    commandLine 'bash', '-lc', '''
set -euo pipefail
if command -v cpd >/dev/null 2>&1; then
  CPD_CMD="cpd"
elif command -v pmd >/dev/null 2>&1; then
  CPD_CMD="pmd cpd"
elif [ -x "/opt/homebrew/opt/pmd/libexec/bin/pmd" ]; then
  CPD_CMD="/opt/homebrew/opt/pmd/libexec/bin/pmd cpd"
elif [ -x "/usr/local/opt/pmd/libexec/bin/pmd" ]; then
  CPD_CMD="/usr/local/opt/pmd/libexec/bin/pmd cpd"
else
  echo "PMD introuvable. Installez-le: brew install pmd et assurez que 'pmd' est dans le PATH."
  exit 0
fi
# Lister les fichiers .fxml (CPD ne scanne pas cette extension par défaut)
find src/main/resources -type f -name "*.fxml" > build/reports/cpd/_fxml-files.txt || true
if [ ! -s build/reports/cpd/_fxml-files.txt ]; then
  echo "[WARN] Aucun fichier FXML trouvé."
  exit 0
fi
# Analyse via filelist; ne pas échouer si des doublons sont trouvés
eval "$CPD_CMD --filelist build/reports/cpd/_fxml-files.txt --language xml --minimum-tokens 45 --format text" > build/reports/cpd/cpd-fxml.txt || true
'''
}

tasks.register('cpdAll') {
    group = 'verification'
    description = 'Exécute CPD pour Java et FXML'
    dependsOn 'cpdJava', 'cpdFxml'
}

if (tasks.findByName('cpdCheck') == null) {
    tasks.register('cpdCheck') {
        group = 'verification'
        dependsOn 'cpdAll'
    }
}

tasks.named("spotbugsMain").configure { enabled = false }
tasks.named("spotbugsTest").configure { enabled = false }

try {
    // Exemple de bloc try-catch pour ignorer les exceptions
    // ...code qui peut lancer une exception...
} catch (Exception e) {
    LOGGER.debug("Ignoré", e);
}

// Exécuter rewriteRun seulement si -Prewrite est présent
tasks.named('rewriteRun').configure {
    onlyIf { project.hasProperty('rewrite') }
}



