plugins {
  id "java"
  id "application"
  id "org.openjfx.javafxplugin" version "0.1.0"
}

java { toolchain { languageVersion = JavaLanguageVersion.of(21) } }
application {
    mainClass = 'com.magsav.App'
}

// Tâche pour exécuter le debugger de base de données
task runDatabaseDebugger(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.magsav.debug.DatabaseDebugger'
}

// Tâche pour diagnostiquer les interventions - résout les problèmes de classpath
task diagnosticInterventions(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.magsav.debug.InterventionTableDiagnostic'
    jvmArgs = ['-Djava.awt.headless=true']
}

// Tâche pour diagnostiquer les rôles utilisateurs
task diagnosticUserRoles(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.magsav.debug.UserRoleDiagnostic'
    jvmArgs = ['-Djava.awt.headless=true']
}

// Tâche pour tester le contrôleur des demandes
task testDemandesController(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.magsav.debug.DemandesControllerTest'
}

// Tâche pour débugger toutes les données
task debugAllData(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.magsav.debug.AllDataDebugger'
}

// Tâche pour lancer l'API
task runApi(type: JavaExec) {
    mainClass = 'com.magsav.api.ApiServer'
    classpath = sourceSets.main.runtimeClasspath
}

// Tâche pour générer les données de test complètes
task generateTestData(type: JavaExec) {
    mainClass = 'com.magsav.util.TestDataGenerator'
    classpath = sourceSets.main.runtimeClasspath
}

// Tâche pour vider et regénérer des données fraîches
task generateFreshData(type: JavaExec) {
    mainClass = 'com.magsav.util.FreshDataGenerator'
    classpath = sourceSets.main.runtimeClasspath
}

// Tâche pour générer uniquement les requests de manière isolée
task generateRequestsOnly(type: JavaExec) {
    mainClass = 'com.magsav.util.RequestsOnlyGenerator'
    classpath = sourceSets.main.runtimeClasspath
    description = 'Génère uniquement les demandes/requests de manière isolée pour éviter les conflits de base de données'
    group = 'data'
}

// Tâche pour générer uniquement les affaires de manière isolée
task generateAffairesOnly(type: JavaExec) {
    mainClass = 'com.magsav.util.AffairesOnlyGenerator'
    classpath = sourceSets.main.runtimeClasspath
    description = 'Génère uniquement les affaires de manière isolée pour éviter les conflits de base de données'
    group = 'data'
}

// Tâche pour importer les données CSV dans H2
task importCSV(type: JavaExec) {
    mainClass = 'com.magsav.utils.CSVImporter'
    classpath = sourceSets.main.runtimeClasspath
    description = 'Importe les données CSV dans H2'
    group = 'data'
}

// Tâche pour vérifier le schéma H2 complet
task verifySchema(type: JavaExec) {
    mainClass = 'com.magsav.utils.SchemaVerifier'
    classpath = sourceSets.main.runtimeClasspath
    description = 'Vérifie la création du schéma H2 complet'
    group = 'verification'
}

// Tâche pour vérification simple du schéma H2
task checkSchema(type: JavaExec) {
    mainClass = 'com.magsav.utils.SimpleSchemaChecker'
    classpath = sourceSets.main.runtimeClasspath
    description = 'Vérification simple du schéma H2'
    group = 'verification'
}

// Tâche pour générer des données de test H2
task generateH2TestData(type: JavaExec) {
    mainClass = 'com.magsav.util.H2TestDataGenerator'
    classpath = sourceSets.main.runtimeClasspath
    description = 'Génère des données de test pour H2'
    group = 'data'
}

// Tâche pour générer des données de test spécifiques aux affaires
task generateAffairesTestData(type: JavaExec) {
    mainClass = 'com.magsav.util.AffairesTestDataGenerator'
    classpath = sourceSets.main.runtimeClasspath
    description = 'Génère des données de test pour les affaires'
    group = 'data'
}

// Tâche pour nettoyer et régénérer les données d'affaires
task resetAffairesData(type: JavaExec) {
    mainClass = 'com.magsav.util.ResetAffairesData'
    classpath = sourceSets.main.runtimeClasspath
    description = 'Nettoie et régénère les données d\'affaires'
    group = 'data'
}

repositories { mavenCentral() }

dependencies {
  // H2 Database - Base de données performante, 100% Java
  implementation "com.h2database:h2:2.2.224"
  implementation "com.zaxxer:HikariCP:5.1.0"
  implementation "org.slf4j:slf4j-api:2.0.13"
  runtimeOnly "ch.qos.logback:logback-classic:1.5.8"
  implementation "org.apache.pdfbox:pdfbox:3.0.3"
  implementation "com.opencsv:opencsv:5.9"
  implementation 'com.google.zxing:core:3.5.3'
  implementation 'com.google.zxing:javase:3.5.3'
  implementation "com.sun.mail:jakarta.mail:2.0.1"
  implementation "com.google.code.gson:gson:2.10.1"
  
  // API REST simple avec Jetty
  implementation "org.eclipse.jetty:jetty-server:11.0.18"
  implementation "org.eclipse.jetty:jetty-servlet:11.0.18"
  implementation "jakarta.servlet:jakarta.servlet-api:5.0.0"
  implementation "com.fasterxml.jackson.core:jackson-databind:2.16.0"
  implementation "com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.16.0"
  
  testImplementation platform("org.junit:junit-bom:5.11.0")
  testImplementation "org.junit.jupiter:junit-jupiter"
  testImplementation "org.mockito:mockito-core:5.8.0"
  testImplementation "org.mockito:mockito-junit-jupiter:5.8.0"
  testRuntimeOnly "org.junit.platform:junit-platform-launcher"
}

javafx {
  version = "21.0.5"
  modules = [ "javafx.controls", "javafx.fxml" ]
}

tasks.withType(JavaCompile).configureEach {
  options.compilerArgs += ['-Xdiags:verbose', '-Xlint:unchecked', '-Xlint:deprecation', '-Xlint:all']
}

test {
  useJUnitPlatform()
  testLogging {
    events = ["passed", "skipped", "failed"]
    exceptionFormat = "full"
  }
  timeout.set(Duration.ofMinutes(10))
}

// Tâche pour tester l'extension de base de données
task testDatabase(type: JavaExec) {
  group = 'verification'
  description = 'Test de l\'extension de base de données'
  classpath = sourceSets.main.runtimeClasspath + sourceSets.test.runtimeClasspath
  mainClass = 'com.magsav.test.TestDatabaseExtension'
  jvmArgs = [
    '--add-exports', 'javafx.controls/com.sun.javafx.scene.control.behavior=ALL-UNNAMED',
    '--add-exports', 'javafx.controls/com.sun.javafx.scene.control=ALL-UNNAMED',
    '--add-exports', 'javafx.base/com.sun.javafx.binding=ALL-UNNAMED',
    '--add-exports', 'javafx.base/com.sun.javafx.event=ALL-UNNAMED',
    '--add-exports', 'javafx.graphics/com.sun.javafx.stage=ALL-UNNAMED'
  ]
}

task qualityCheck(dependsOn: ['compileJava', 'compileTestJava', 'test']) {
  doLast {
    println "Verifications de qualite terminees"
    println "- Compilation: SUCCESS"
    println "- Tests: EXECUTED"
  }
}
