plugins {
  id "java"
  id "application"
  id "org.openjfx.javafxplugin" version "0.1.0"
}

java { toolchain { languageVersion = JavaLanguageVersion.of(21) } }
application { mainClass = "com.magsav.App" }

// Tâche pour lancer l'API
task runApi(type: JavaExec) {
    mainClass = 'com.magsav.api.ApiServer'
    classpath = sourceSets.main.runtimeClasspath
}

// Tâche pour générer les données de test complètes
task generateTestData(type: JavaExec) {
    mainClass = 'com.magsav.util.ComprehensiveTestDataGenerator'
    classpath = sourceSets.main.runtimeClasspath
}

// Tâche pour vider et regénérer des données fraîches
task generateFreshData(type: JavaExec) {
    mainClass = 'com.magsav.util.FreshDataGenerator'
    classpath = sourceSets.main.runtimeClasspath
}

repositories { mavenCentral() }

dependencies {
  implementation "org.xerial:sqlite-jdbc:3.47.1.0"
  implementation "com.zaxxer:HikariCP:5.1.0"
  implementation "org.slf4j:slf4j-api:2.0.13"
  runtimeOnly "ch.qos.logback:logback-classic:1.5.8"
  implementation "org.apache.pdfbox:pdfbox:3.0.3"
  implementation "com.opencsv:opencsv:5.9"
  implementation 'com.google.zxing:core:3.5.3'
  implementation 'com.google.zxing:javase:3.5.3'
  implementation "com.sun.mail:jakarta.mail:2.0.1"
  implementation "com.google.code.gson:gson:2.10.1"
  
  // API REST simple avec Jetty
  implementation "org.eclipse.jetty:jetty-server:11.0.18"
  implementation "org.eclipse.jetty:jetty-servlet:11.0.18"
  implementation "jakarta.servlet:jakarta.servlet-api:5.0.0"
  implementation "com.fasterxml.jackson.core:jackson-databind:2.16.0"
  implementation "com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.16.0"
  
  testImplementation platform("org.junit:junit-bom:5.11.0")
  testImplementation "org.junit.jupiter:junit-jupiter"
  testImplementation "org.mockito:mockito-core:5.8.0"
  testImplementation "org.mockito:mockito-junit-jupiter:5.8.0"
  testRuntimeOnly "org.junit.platform:junit-platform-launcher"
}

javafx {
  version = "21.0.5"
  modules = [ "javafx.controls", "javafx.fxml" ]
}

tasks.withType(JavaCompile).configureEach {
  options.compilerArgs += ['-Xdiags:verbose']
}

test {
  useJUnitPlatform()
  testLogging {
    events = ["passed", "skipped", "failed"]
    exceptionFormat = "full"
  }
  timeout.set(Duration.ofMinutes(10))
}

// Tâche pour tester l'extension de base de données
task testDatabase(type: JavaExec) {
  group = 'verification'
  description = 'Test de l\'extension de base de données'
  classpath = sourceSets.main.runtimeClasspath + sourceSets.test.runtimeClasspath
  mainClass = 'com.magsav.test.TestDatabaseExtension'
  jvmArgs = [
    '--add-exports', 'javafx.controls/com.sun.javafx.scene.control.behavior=ALL-UNNAMED',
    '--add-exports', 'javafx.controls/com.sun.javafx.scene.control=ALL-UNNAMED',
    '--add-exports', 'javafx.base/com.sun.javafx.binding=ALL-UNNAMED',
    '--add-exports', 'javafx.base/com.sun.javafx.event=ALL-UNNAMED',
    '--add-exports', 'javafx.graphics/com.sun.javafx.stage=ALL-UNNAMED'
  ]
}

task qualityCheck(dependsOn: ['compileJava', 'compileTestJava', 'test']) {
  doLast {
    println "Verifications de qualite terminees"
    println "- Compilation: SUCCESS"
    println "- Tests: EXECUTED"
  }
}
